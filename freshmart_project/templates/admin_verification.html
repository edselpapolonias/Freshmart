{% include "partials/header.html" %}
<body class="sb-nav-fixed">
{% include "partials/navbar.html" %}

<div id="layoutSidenav">
    {% include "partials/sidebar.html" %}
    <div id="layoutSidenav_content">
        <main>
            {% block content %}
            <div class="container mt-5">
                
                {% csrf_token %} 

                <h2>Admin Account Verification</h2>

                <div id="messages">
                    {% if messages %}
                        {% for message in messages %}
                            <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                                {{ message }}
                                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                            </div>
                        {% endfor %}
                    {% endif %}
                </div>

                <table class="table table-bordered mt-4">
                    <thead class="table-dark">
                        <tr>
                            <th>Username</th>
                            <th>Email</th>
                            <th>Gender</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for profile in pending_admins %}
                        <tr id="row-{{ profile.id }}">
                            <td>{{ profile.user.username }}</td>
                            <td>{{ profile.user.email }}</td>
                            <td>{{ profile.gender }}</td>
                            <td>
                                <button class="btn btn-info btn-sm btn-view" 
                                        data-bs-toggle="modal" 
                                        data-bs-target="#viewAdminModal"
                                        data-username="{{ profile.user.username }}"
                                        data-firstname="{{ profile.user.first_name }}"
                                        data-lastname="{{ profile.user.last_name }}"
                                        data-email="{{ profile.user.email }}"
                                        data-gender="{{ profile.gender }}"
                                        data-picture="{% if profile.picture %}{{ profile.picture.url }}{% else %}/static/images/default-avatar.png{% endif %}">
                                    View
                                </button>

                                <button class="btn btn-success btn-sm btn-approve" 
                                        data-id="{{ profile.id }}" 
                                        data-url="{% url 'approve_admin' profile.id %}">Accept</button>

                                <button class="btn btn-danger btn-sm btn-decline" 
                                        data-id="{{ profile.id }}" 
                                        data-url="{% url 'decline_admin' profile.id %}">Decline</button>
                            </td>
                        </tr>
                        {% empty %}
                        <tr id="no-pending">
                            <td colspan="4" class="text-center">No pending admin verifications.</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% endblock %}
        </main>
        {% include "partials/footer.html" %}
    </div>
</div>

{% include "partials/scripts.html" %}

<!-- Admin Details Modal -->
<div class="modal fade" id="viewAdminModal" tabindex="-1" aria-labelledby="viewAdminModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="viewAdminModalLabel">Admin Details</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="text-center mb-3">
          <img id="admin-picture" src="" alt="Profile Picture" class="img-fluid rounded-circle" style="max-width: 150px;">
        </div>
        <ul class="list-group">
          <li class="list-group-item"><strong>Username:</strong> <span id="admin-username"></span></li>
          <li class="list-group-item"><strong>First Name:</strong> <span id="admin-firstname"></span></li>
          <li class="list-group-item"><strong>Last Name:</strong> <span id="admin-lastname"></span></li>
          <li class="list-group-item"><strong>Email:</strong> <span id="admin-email"></span></li>
          <li class="list-group-item"><strong>Gender:</strong> <span id="admin-gender"></span></li>
        </ul>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {

    const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;

    function handleAction(btnClass, alertType) {
        document.querySelectorAll(btnClass).forEach(btn => {
            btn.addEventListener('click', function(e) {
                e.preventDefault();
                const profileId = this.dataset.id;
                const url = this.dataset.url;

                this.disabled = true;

                fetch(url, {
                    method: 'POST',
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest',
                        'X-CSRFToken': csrftoken,
                    },
                })
                .then(response => response.json())
                .then(data => {
                    if(data.success){
                        const row = document.getElementById('row-' + profileId);
                        if(row) row.remove();

                        showMessage(alertType, data.message);

                        const tbody = document.querySelector('table tbody');
                        if(tbody.querySelectorAll('tr').length === 0){
                            const row = document.createElement('tr');
                            row.id = 'no-pending';
                            row.innerHTML = `<td colspan="4" class="text-center">No pending admin verifications.</td>`;
                            tbody.appendChild(row);
                        }
                    } else {
                        showMessage('danger', data.message || 'An error occurred.');
                        this.disabled = false;
                    }
                })
                .catch(err => {
                    showMessage('danger', 'An error occurred. Please try again.');
                    this.disabled = false;
                });
            });
        });
    }

    handleAction('.btn-approve', 'success');
    handleAction('.btn-decline', 'danger');

    // Handle View button for modal
    document.querySelectorAll('.btn-view').forEach(btn => {
        btn.addEventListener('click', function() {
            document.getElementById('admin-username').textContent = this.dataset.username;
            document.getElementById('admin-firstname').textContent = this.dataset.firstname;
            document.getElementById('admin-lastname').textContent = this.dataset.lastname;
            document.getElementById('admin-email').textContent = this.dataset.email;
            document.getElementById('admin-gender').textContent = this.dataset.gender;
            const picture = this.dataset.picture || '/static/images/default-avatar.png';
            document.getElementById('admin-picture').src = picture;
        });
    });

    function showMessage(type, message){
        const container = document.getElementById('messages');
        const alert = document.createElement('div');
        alert.className = `alert alert-${type} alert-dismissible fade show mt-2`;
        alert.innerHTML = `${message} <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>`;
        container.appendChild(alert);
    }
});
</script>
</body>
</html>
