{% include "partials/header.html" %}
<body class="sb-nav-fixed">
{% include "partials/navbar.html" %}

<div id="layoutSidenav">
    {% include "partials/sidebar.html" %}
    <div id="layoutSidenav_content">
        <main>
            {% block content %}
            <div class="container mt-5">
                
                {% csrf_token %} 

                <h2>Admin Account Verification</h2>

                <div id="messages">
                    {% if messages %}
                        {% for message in messages %}
                            <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                                {{ message }}
                                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                            </div>
                        {% endfor %}
                    {% endif %}
                </div>

                <table class="table table-hover table-striped mt-4 shadow rounded-4">
                    <thead class="table-success text-success text-center align-middle sticky-top" style="top: 0; z-index: 10;">
                        <tr>
                            <th class="text-start ps-4">Username</th>
                            <th class="text-start">Email</th>
                            <th class="text-center">Gender</th>
                            <th class="text-center">Action</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for profile in pending_admins %}
                        <tr id="row-{{ profile.id }}" class="align-middle">
                            <td class="text-start ps-4 fw-semibold">{{ profile.user.username }}</td>
                            <td class="text-start text-truncate" style="max-width: 280px;" title="{{ profile.user.email }}">{{ profile.user.email }}</td>
                            <td class="text-center text-capitalize">{{ profile.gender }}</td>
                            <td class="text-center">
                                <button class="btn btn-info btn-sm btn-view me-2" 
                                        data-bs-toggle="modal" 
                                        data-bs-target="#viewAdminModal"
                                        data-username="{{ profile.user.username }}"
                                        data-firstname="{{ profile.user.first_name }}"
                                        data-lastname="{{ profile.user.last_name }}"
                                        data-email="{{ profile.user.email }}"
                                        data-gender="{{ profile.gender }}"
                                        data-picture="{% if profile.picture %}{{ profile.picture.url }}{% else %}/static/images/default-avatar.png{% endif %}">
                                    <i class="bi bi-eye-fill"></i> View
                                </button>

                                <button class="btn btn-success btn-sm btn-approve me-2" 
                                        data-id="{{ profile.id }}" 
                                        data-url="{% url 'approve_admin' profile.id %}">
                                    <i class="bi bi-check-circle-fill"></i> Accept
                                </button>

                                <button class="btn btn-danger btn-sm btn-decline" 
                                        data-id="{{ profile.id }}" 
                                        data-url="{% url 'decline_admin' profile.id %}">
                                    <i class="bi bi-x-circle-fill"></i> Decline
                                </button>
                            </td>
                        </tr>
                        {% empty %}
                        <tr id="no-pending">
                            <td colspan="4" class="text-center fst-italic text-muted py-4">No pending admin verifications.</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% endblock %}
        </main>
        {% include "partials/footer.html" %}
    </div>
</div>

{% include "partials/scripts.html" %}

<div class="modal fade" id="viewAdminModal" tabindex="-1" aria-labelledby="viewAdminModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-md">
    <div class="modal-content border-0 shadow-lg rounded-4">
      <div class="modal-header border-0 pb-0">
        <h5 class="modal-title fw-bold text-success" id="viewAdminModalLabel">Admin Details</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body pt-2">
        <div class="text-center mb-4">
          <img id="admin-picture" src="" alt="Profile Picture" class="img-fluid rounded-circle border border-3 border-success" style="max-width: 140px; height: 140px; object-fit: cover;">
        </div>
        <ul class="list-group list-group-flush">
          <li class="list-group-item d-flex align-items-center gap-2">
            <i class="bi bi-person-fill text-success fs-5"></i>
            <span class="text-muted fw-semibold me-1">Username:</span>
            <span id="admin-username" class="flex-grow-1 fw-medium text-dark"></span>
          </li>
          <li class="list-group-item d-flex align-items-center gap-2">
            <i class="bi bi-person-badge-fill text-success fs-5"></i>
            <span class="text-muted fw-semibold me-1">First Name:</span>
            <span id="admin-firstname" class="flex-grow-1 fw-medium text-dark"></span>
          </li>
          <li class="list-group-item d-flex align-items-center gap-2">
            <i class="bi bi-person-badge text-success fs-5"></i>
            <span class="text-muted fw-semibold me-1">Last Name:</span>
            <span id="admin-lastname" class="flex-grow-1 fw-medium text-dark"></span>
          </li>
          <li class="list-group-item d-flex align-items-center gap-2">
            <i class="bi bi-envelope-fill text-success fs-5"></i>
            <span class="text-muted fw-semibold me-1">Email:</span>
            <span id="admin-email" class="flex-grow-1 fw-medium text-dark"></span>
          </li>
          <li class="list-group-item d-flex align-items-center gap-2">
            <i class="bi bi-gender-ambiguous text-success fs-5"></i>
            <span class="text-muted fw-semibold me-1">Gender:</span>
            <span id="admin-gender" class="flex-grow-1 fw-medium text-dark"></span>
          </li>
        </ul>
      </div>
      <div class="modal-footer border-0 pt-0">
        <button type="button" class="btn btn-outline-success fw-semibold" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {

    const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;

    function handleAction(btnClass, alertType) {
        document.querySelectorAll(btnClass).forEach(btn => {
            btn.addEventListener('click', function(e) {
                e.preventDefault();
                const profileId = this.dataset.id;
                const url = this.dataset.url;

                this.disabled = true;

                fetch(url, {
                    method: 'POST',
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest',
                        'X-CSRFToken': csrftoken,
                    },
                })
                .then(response => response.json())
                .then(data => {
                    if(data.success){
                        const row = document.getElementById('row-' + profileId);
                        if(row) row.remove();

                        showMessage(alertType, data.message);

                        const tbody = document.querySelector('table tbody');
                        if(tbody.querySelectorAll('tr').length === 0){
                            const row = document.createElement('tr');
                            row.id = 'no-pending';
                            row.innerHTML = `<td colspan="4" class="text-center">No pending admin verifications.</td>`;
                            tbody.appendChild(row);
                        }
                    } else {
                        showMessage('danger', data.message || 'An error occurred.');
                        this.disabled = false;
                    }
                })
                .catch(err => {
                    showMessage('danger', 'An error occurred. Please try again.');
                    this.disabled = false;
                });
            });
        });
    }

    handleAction('.btn-approve', 'success');
    handleAction('.btn-decline', 'danger');

    // Handle View button for modal
    document.querySelectorAll('.btn-view').forEach(btn => {
        btn.addEventListener('click', function() {
            document.getElementById('admin-username').textContent = this.dataset.username;
            document.getElementById('admin-firstname').textContent = this.dataset.firstname;
            document.getElementById('admin-lastname').textContent = this.dataset.lastname;
            document.getElementById('admin-email').textContent = this.dataset.email;
            document.getElementById('admin-gender').textContent = this.dataset.gender;
            const picture = this.dataset.picture || '/static/images/default-avatar.png';
            document.getElementById('admin-picture').src = picture;
        });
    });

    function showMessage(type, message){
        const container = document.getElementById('messages');
        const alert = document.createElement('div');
        alert.className = `alert alert-${type} alert-dismissible fade show mt-2`;
        alert.innerHTML = `${message} <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>`;
        container.appendChild(alert);
    }
});
</script>
</body>
</html>
