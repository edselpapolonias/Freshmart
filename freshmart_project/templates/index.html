{% include "partials/header.html" %}
<body class="sb-nav-fixed">
    {% include "partials/navbar.html" %}
    <div id="layoutSidenav">
        {% include "partials/sidebar.html" %}
        <div id="layoutSidenav_content">
            <main>
                <div class="container-fluid px-4">
                    <h1 class="mt-4 fw-bold text-success">Dashboard</h1>
                    <ol class="breadcrumb mb-4">
                        <li class="breadcrumb-item active">Dashboard</li>
                    </ol>

                    <div class="row g-4 mb-4">
                        <div class="col-xl-3 col-md-6">
                            <div class="card shadow-sm rounded-4 text-white bg-primary h-100">
                                <div class="card-body d-flex flex-column justify-content-center align-items-center py-4">
                                    <h5 class="mb-2 fw-semibold">Total Products</h5>
                                    <h2 class="fw-bold">{{ total_products }}</h2>
                                </div>
                            </div>
                        </div>

                        <div class="col-xl-3 col-md-6">
                            <div class="card shadow-sm rounded-4 text-white bg-success h-100">
                                <div class="card-body d-flex flex-column justify-content-center align-items-center py-4">
                                    <h5 class="mb-2 fw-semibold">Total Value of Inventory</h5>
                                    <h2 class="fw-bold">â‚±{{ total_value }}</h2>
                                </div>
                            </div>
                        </div>

                        <div class="col-xl-3 col-md-6">
                            <div class="card shadow-sm rounded-4 text-white bg-warning h-100">
                                <div class="card-body d-flex flex-column justify-content-center align-items-center py-4">
                                    <h5 class="mb-2 fw-semibold">Low Stock</h5>
                                    <h2 class="fw-bold">{{ low_stock }}</h2>
                                </div>
                            </div>
                        </div>

                        <div class="col-xl-3 col-md-6">
                            <div class="card shadow-sm rounded-4 text-white bg-danger h-100">
                                <div class="card-body d-flex flex-column justify-content-center align-items-center py-4">
                                    <h5 class="mb-2 fw-semibold">Out of Stock</h5>
                                    <h2 class="fw-bold">{{ out_of_stock }}</h2>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="card shadow-sm rounded-4 mb-4">
                        <div class="card-header bg-success text-white d-flex align-items-center">
                            <i class="fas fa-table me-2"></i>
                            <span class="fw-semibold fs-5">Product List</span>
                        </div>
                        <div class="card-body p-0">
                            <div class="table-responsive">
                                <table class="table table-bordered table-striped mb-0">
                                    <thead class="table-success text-success text-center align-middle">
                                        <tr>
                                            <th>Product Name</th>
                                            <th>Quantity in Stock</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for product in products_list %}
                                        <tr class="text-center align-middle">
                                            <td class="text-start">{{ product.product_name }}</td>
                                            <td>{{ product.quantity_in_stock }}</td>
                                        </tr>
                                        {% empty %}
                                        <tr>
                                            <td colspan="2" class="text-center text-muted fst-italic py-4">
                                                No products available.
                                            </td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <div class="card shadow-sm rounded-4 mb-4">
                        <div class="card-header bg-success text-white d-flex align-items-center">
                            <i class="fas fa-chart-pie me-2"></i>
                            <span class="fw-semibold fs-5">Stock Quantity by Category Distribution</span>
                        </div>
                        <div class="card-body d-flex justify-content-center align-items-center p-4">
                            <div style="max-width: 500px; max-height: 500px;">
                                <canvas id="categoryPieChart"></canvas>
                            </div>
                        </div>
                    </div>

                    <div class="card shadow-sm rounded-4 mb-4">
                        <div class="card-header bg-success text-white d-flex align-items-center">
                            <i class="fas fa-chart-bar me-2"></i>
                            <span class="fw-semibold fs-5">Total Inventory Value by Category</span>
                        </div>
                        <div class="card-body p-4">
                            <canvas id="categoryBarChart" style="max-height: 400px;"></canvas>
                        </div>
                    </div>

                    <div class="card shadow-sm rounded-4 mb-4">
                        <div class="card-header bg-success text-white d-flex align-items-center">
                            <i class="fas fa-chart-line me-2"></i>
                            <span class="fw-semibold fs-5">Product Price Comparison</span>
                        </div>
                        <div class="card-body p-4" style="padding-bottom: 3rem;">
                            <canvas id="productPriceLineChart" style="max-height: 700px;"></canvas>
                        </div>
                    </div>
            </main>

            {% include "partials/footer.html" %}
        </div>
    </div>

    {% include "partials/scripts.html" %}
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

    <script>
    document.addEventListener('DOMContentLoaded', function() {
        // Pie Chart Data Fetch & Render
        fetch('{% url "category_quantity_data" %}')
            .then(response => {
                if (!response.ok) throw new Error('Network response was not ok');
                return response.json();
            })
            .then(data => {
                const ctx = document.getElementById('categoryPieChart');

                if (data.labels.length === 0) {
                    const container = ctx.parentElement.parentElement;
                    container.innerHTML = '<p class="text-center text-muted fst-italic py-5">No products currently in stock to display on chart.</p>';
                    return;
                }

                const chartColors = [
                    '#1cc88a', '#4e73df', '#36b9cc', '#f6c23e', '#e74a3b',
                    '#858796', '#6610f2', '#fd7e14', '#20c997', '#6f42c1'
                ];

                new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: data.labels,
                        datasets: [{
                            data: data.quantities,
                            backgroundColor: chartColors.slice(0, data.labels.length),
                            hoverOffset: 8,
                            borderWidth: 1,
                        }],
                    },
                    options: {
                        maintainAspectRatio: false,
                        responsive: true,
                        plugins: {
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        let label = context.label || '';
                                        let value = context.parsed;
                                        return label + ': ' + value.toLocaleString() + ' units';
                                    }
                                }
                            },
                            legend: {
                                display: true,
                                position: 'bottom',
                                labels: {
                                    boxWidth: 12,
                                    padding: 15
                                }
                            }
                        },
                        cutout: '80%',
                    },
                });
            })
            .catch(error => {
                console.error('Error fetching chart data:', error);
                const container = document.getElementById('categoryPieChart').parentElement;
                container.innerHTML = '<p class="text-center text-danger fst-italic py-5">Error loading chart data. Check server logs or if "category_quantity_data" URL is defined.</p>';
            });
    });
    </script>

    <script>
    document.addEventListener('DOMContentLoaded', function() {
        // Bar Chart Data Fetch & Render - Total Inventory Value by Category
        fetch('{% url "category_value_data" %}')
            .then(response => {
                if (!response.ok) throw new Error('Network response was not ok');
                return response.json();
            })
            .then(data => {
                const ctx = document.getElementById('categoryBarChart');

                if (data.labels.length === 0) {
                    const container = ctx.parentElement;
                    container.innerHTML = '<p class="text-center text-muted fst-italic py-5">No products with stock and price found to calculate value.</p>';
                    return;
                }

                const chartColors = [
                    '#1cc88a', '#4e73df', '#36b9cc', '#f6c23e', '#e74a3b',
                    '#858796', '#6610f2', '#fd7e14', '#20c997', '#6f42c1'
                ];

                new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: data.labels,
                        datasets: [{
                            label: 'Total Value',
                            data: data.values,
                            backgroundColor: chartColors.slice(0, data.labels.length),
                            borderColor: chartColors.slice(0, data.labels.length),
                            borderWidth: 1,
                            borderRadius: 5,
                            maxBarThickness: 40
                        }],
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        indexAxis: 'y', // Makes it a horizontal bar chart
                        scales: {
                            x: {
                                beginAtZero: true,
                                title: {
                                    display: true,
                                    text: 'Total Value (â‚±)',
                                    color: '#198754',
                                    font: { weight: 'bold' }
                                },
                                ticks: {
                                    color: '#198754',
                                    callback: function(value) {
                                        return 'â‚±' + value.toLocaleString();
                                    }
                                },
                                grid: {
                                    color: '#d1e7dd'
                                }
                            },
                            y: {
                                ticks: {
                                    color: '#198754',
                                    font: { weight: 'bold' }
                                },
                                grid: {
                                    display: false
                                }
                            }
                        },
                        plugins: {
                            legend: { display: false },
                            tooltip: {
                                backgroundColor: '#198754',
                                titleColor: '#e6f4ea',
                                bodyColor: '#e6f4ea',
                                callbacks: {
                                    label: function(context) {
                                        let value = context.parsed.x;
                                        return 'â‚±' + value.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 });
                                    }
                                }
                            }
                        }
                    }
                });
            })
            .catch(error => {
                console.error('Error fetching category value data:', error);
                const container = document.getElementById('categoryBarChart').parentElement;
                container.innerHTML = '<p class="text-center text-danger fst-italic py-5">Error loading category value chart data.</p>';
            });
    });
    </script>

    <script>
    document.addEventListener('DOMContentLoaded', function() {
        // Line Chart Data Fetch & Render - Product Price Comparison
        fetch('{% url "product_price_data" %}')
            .then(response => {
                if (!response.ok) throw new Error('Network response was not ok');
                return response.json();
            })
            .then(data => {
                const ctx = document.getElementById('productPriceLineChart');

                if (data.labels.length === 0) {
                    const container = ctx.parentElement;
                    container.innerHTML = '<p class="text-center text-muted fst-italic py-5">No products found to compare prices.</p>';
                    return;
                }
                
                // Define the primary color (success green) for the line
                const lineColor = '#1cc88a'; 

                new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: data.labels,
                        datasets: [{
                            label: 'Price (â‚±)',
                            data: data.prices,
                            backgroundColor: 'rgba(28, 200, 138, 0.2)', // Light green fill area under the line
                            borderColor: lineColor,
                            borderWidth: 3,
                            pointRadius: 5,
                            pointBackgroundColor: lineColor,
                            pointBorderColor: '#fff',
                            pointHoverRadius: 8,
                            pointHoverBackgroundColor: lineColor,
                            pointHoverBorderColor: 'rgba(220, 220, 220, 1)',
                            tension: 0.4, // Makes the line curved/smooth
                            fill: true, // Fill the area under the line
                        }],
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            x: {
                                grid: { display: false },
                                title: { 
                                    display: true, 
                                    text: '',
                                    color: '#198754',
                                    font: { weight: 'bold' }
                                },
                                ticks: { 
                                    color: '#198754',
                                    maxRotation: 25, // Set max rotation to 45 degrees
                                    minRotation: 25  // Set min rotation to 45 degrees
                                }
                            },
                            y: {
                                beginAtZero: true,
                                title: {
                                    display: true,
                                    text: 'Price (â‚±)',
                                    color: '#198754',
                                    font: { weight: 'bold' }
                                },
                                ticks: {
                                    color: '#198754',
                                    callback: function(value) {
                                        return 'â‚±' + value.toLocaleString();
                                    }
                                },
                                grid: {
                                    color: '#d1e7dd'
                                }
                            }
                        },
                        plugins: {
                            legend: { display: false },
                            tooltip: {
                                backgroundColor: '#198754',
                                titleColor: '#e6f4ea',
                                bodyColor: '#e6f4ea',
                                callbacks: {
                                    label: function(context) {
                                        let label = context.dataset.label || '';
                                        let value = context.parsed.y;
                                        return label + ': â‚±' + value.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 });
                                    }
                                }
                            }
                        }
                    }
                });
            })
            .catch(error => {
                console.error('Error fetching product price data:', error);
                const container = document.getElementById('productPriceLineChart').parentElement;
                container.innerHTML = '<p class="text-center text-danger fst-italic py-5">Error loading product price chart data.</p>';
            });
    });
    </script>



    </body>
</html>